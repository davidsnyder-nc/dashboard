<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localhost Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display.swap" rel="stylesheet">
    
    <!-- SortableJS for drag-and-drop in settings -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- JSZip for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Favicon: Prevents console errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    
    <style>
        /* Use Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom animation for cards appearing */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Apply animation to cards */
        .card-animated {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0; /* Start hidden */
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5); /* gray-400 with opacity */
            border-radius: 20px;
            border: 3px solid transparent;
        }

        /* Styles for SortableJS drag-and-drop placeholders */
        .sortable-ghost {
            background: rgba(59, 130, 246, 0.1); /* blue-500 with opacity */
            border: 2px dashed rgba(59, 130, 246, 0.5);
            opacity: 0.7;
        }
        .sortable-chosen {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-300">

    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen">
        
        <!-- Header -->
        <header class="sticky top-0 z-30 backdrop-blur-lg bg-slate-50/80 border-b border-slate-200">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <!-- Title -->
                    <div class="flex items-center gap-4">
                        <img src="/images/me.png" alt="Logo" class="w-10 h-10 rounded-full object-cover" onerror="this.style.display='none'">
                        <h1 class="text-2xl font-bold text-slate-900">
                            web.<span class="text-blue-500">server</span>
                        </h1>
                    </div>
                    <!-- Header Buttons -->
                    <div class="flex items-center gap-2">
                        <!-- Glances Link -->
                        <div id="glances-link-container" class="hidden">
                            <button onclick="openGlancesModal()" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Open Glances">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                            </button>
                        </div>
                        <!-- View Toggle Button -->
                        <button id="view-toggle-button" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Switch View">
                            <!-- Icon will be set by JS -->
                        </button>
                        <!-- Settings Button -->
                        <button id="settings-button" onclick="openSettings()" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Settings">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <!-- Glances System Stats -->
            <div id="glances-stats" class="mb-10 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- CPU Card -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-600 mb-2">CPU Usage</h3>
                        <div class="flex items-baseline justify-between">
                            <span id="cpu-usage" class="text-4xl font-bold text-slate-800">...</span>
                            <span class="text-2xl font-medium text-slate-500">%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 mt-4">
                            <div id="cpu-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Memory Card -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-600 mb-2">Memory Usage</h3>
                        <div class="flex items-baseline justify-between">
                            <span id="mem-usage" class="text-4xl font-bold text-slate-800">...</span>
                            <span class="text-2xl font-medium text-slate-500">%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 mt-4">
                            <div id="mem-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Disk Card -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-600 mb-2">Disk Usage</h3>
                        <div class="flex items-baseline justify-between">
                            <span id="disk-usage" class="text-4xl font-bold text-slate-800">...</span>
                             <span class="text-2xl font-medium text-slate-500">%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5 mt-4">
                            <div id="disk-bar" class="bg-purple-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Grid -->
            <div id="websites-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Website cards will be injected here by JavaScript -->
            </div>
            
            <!-- Website List (Spreadsheet View) -->
            <div id="websites-list" class="hidden">
                <!-- List view will be injected here -->
            </div>
        </main>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container" class="hidden"></div>
    
    <!-- Gemini Chatbot FAB -->
    <button onclick="openChatbot()" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-110 z-40">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </button>

    <script>
        // --- Global State ---
        let allSettings = {};
        let chatHistory = [];
        let glancesInterval;
        let currentView = 'grid'; // 'grid' or 'list'
        let listSortConfig = { by: 'name', order: 'asc' }; // 'name' or 'updated'
        let siteDataCache = []; // Cache the fetched project data
        const PROXY_URL = 'https://corsproxy.io/?';

        // --- Utility Functions ---

        /**
         * Fetches data from the backend PHP script.
         * @param {string} params - The query parameters for the request.
         * @returns {Promise<any>} - The JSON response from the backend.
         */
        async function fetchFromBackend(params) {
            try {
                const response = await fetch(`browser.php?${params}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching from backend:', error);
                return { error: error.message };
            }
        }

        /**
         * Closes any open modal.
         */
        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            const modal = modalContainer.querySelector('.modal-content');
            if (modal) {
                modal.classList.add('animate-fadeOut');
                modal.parentElement.classList.add('animate-fadeOut');
                setTimeout(() => {
                    modalContainer.innerHTML = '';
                    modalContainer.classList.add('hidden');
                }, 300); // Match animation duration
            }
        }

        // --- Settings Modal ---

        /**
         * Moves a settings item to the top of the list.
         * @param {HTMLElement} button - The button element that was clicked.
         */
        function moveToTop(button) {
            const item = button.closest('.settings-item');
            if (item) {
                item.parentElement.prepend(item);
            }
        }

        /**
         * Moves a settings item to the bottom of the list.
         * @param {HTMLElement} button - The button element that was clicked.
         */
        function moveToBottom(button) {
            const item = button.closest('.settings-item');
            if (item) {
                item.parentElement.appendChild(item);
            }
        }

        /**
         * Resets sorting to alphabetical and unhides all folders.
         */
        function restoreDefaultSettings() {
            allSettings.websitesOrder = []; // Clear custom order
            if (allSettings.websites) {
                for (const siteName in allSettings.websites) {
                    if (allSettings.websites.hasOwnProperty(siteName)) {
                        allSettings.websites[siteName].isHidden = false;
                    }
                }
            }
            // Re-render the settings panel to show the changes immediately
            loadWebsiteSettingsPanel();
        }

        /**
         * Opens the settings modal.
         */
        function openSettings() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            const glancesSettings = allSettings.glances || {};
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn">
                    <div id="settingsModal" class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-scaleIn">
                        <!-- Modal Header -->
                        <div class="flex justify-between items-center p-5 border-b border-slate-200">
                            <h2 class="text-xl font-semibold text-slate-900">Dashboard Settings</h2>
                            <button class="text-slate-500 hover:text-blue-500 transition-colors" onclick="closeModal()">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        
                        <!-- Modal Tabs -->
                        <div class="flex border-b border-slate-200 px-6">
                            <button class="py-3 px-4 font-medium text-sm border-b-2 border-blue-500 text-blue-500" onclick="switchSettingsTab('websites', this)">Websites</button>
                            <button class="py-3 px-4 font-medium text-sm border-b-2 border-transparent text-slate-500 hover:text-blue-500" onclick="switchSettingsTab('general', this)">General</button>
                            <button class="py-3 px-4 font-medium text-sm border-b-2 border-transparent text-slate-500 hover:text-blue-500" onclick="switchSettingsTab('backup', this)">Backup</button>
                        </div>

                        <!-- Modal Body -->
                        <div id="websitesSettings" class="settings-tab-content flex-grow overflow-y-auto p-6 space-y-4">
                             <div class="p-4 bg-slate-100 rounded-lg">
                                <h3 class="font-semibold mb-2 text-slate-800">GitHub Sync</h3>
                                <p class="text-sm text-slate-600 mb-4">Fetch the latest descriptions and repository topics (tags) for all projects linked to a GitHub repository.</p>
                                <button id="refresh-github-btn" onclick="refreshAllGitHubData()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                    Refresh GitHub Data
                                </button>
                            </div>
                            <div id="website-list-container">
                                <!-- Website list will be loaded here -->
                            </div>
                        </div>
                        <div id="generalSettings" class="settings-tab-content flex-grow overflow-y-auto p-6 space-y-4 hidden">
                            <div class="p-4 bg-slate-100 rounded-lg">
                                <h3 class="font-semibold mb-2 text-slate-800">Glances System Monitor</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="flex items-center gap-2 text-sm text-slate-700">
                                            <input type="checkbox" id="glancesEnabled" class="rounded" ${glancesSettings.enabled ? 'checked' : ''}>
                                            Enable On-Page System Monitor
                                        </label>
                                        <p class="text-xs text-slate-500 mt-1">Requires the <code>glances.php</code> file to be present on your server.</p>
                                    </div>
                                    <div class="pt-2">
                                        <label for="glancesUrl" class="block text-sm font-medium text-slate-700 mb-1">External Glances URL (optional)</label>
                                        <input type="url" id="glancesUrl" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${glancesSettings.url || ''}" placeholder="http://192.168.1.100:61208">
                                        <p class="text-xs text-slate-500 mt-1">If set, a link will appear in the header to open Glances in a modal.</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Gemini API Key</label>
                                <input type="password" id="geminiApiKey" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${allSettings.geminiApiKey || ''}" placeholder="Enter your Gemini API Key">
                                <p class="text-xs text-slate-500 mt-1">Your key is stored in your browser's local storage and also saved to settings.json on your server.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">GitHub Token</label>
                                <input type="password" id="githubToken" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${allSettings.githubToken || ''}" placeholder="Enter your GitHub Personal Access Token">
                                <p class="text-xs text-slate-500 mt-1">Used to fetch project descriptions and backup repositories.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Custom Chatbot Context</label>
                                <textarea id="chatbotContext" class="w-full h-32 px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Provide any additional context for the chatbot here...">${allSettings.chatbotContext || ''}</textarea>
                                <p class="text-xs text-slate-500 mt-1">The chatbot automatically reads context from <strong>server-info.html</strong> in your root directory, if it exists.</p>
                            </div>
                        </div>
                        <div id="backupSettings" class="settings-tab-content flex-grow overflow-y-auto p-6 space-y-6 hidden">
                             <div class="p-4 bg-slate-100 rounded-lg">
                                <h3 class="font-semibold mb-2 text-slate-800">Local Project Backup</h3>
                                <p class="text-sm text-slate-600 mb-4">Create a .zip archive of all your project folders on this server. This does not include server configuration files or hidden directories.</p>
                                <button id="backup-all-btn" onclick="backupAllProjects()" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md">
                                    Create & Download Local Backup
                                </button>
                            </div>
                            <div class="p-4 bg-slate-100 rounded-lg">
                                <h3 class="font-semibold mb-2 text-slate-800">GitHub Repositories Backup</h3>
                                <p class="text-sm text-slate-600 mb-4">Download a .zip archive of all your personal repositories from GitHub. Requires a GitHub Token to be set in General settings.</p>
                                <button id="backup-github-btn" onclick="backupGitHubRepos()" class="w-full px-4 py-2 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900 transition-colors shadow-md">
                                    Create & Download GitHub Backup
                                </button>
                                <p class="text-xs text-center text-slate-500 mt-3">Powered by <a href="https://gitvault.app/" target="_blank" class="text-blue-500 hover:underline">GitVault</a></p>
                            </div>
                        </div>
                        
                        <!-- Modal Footer -->
                        <div class="flex justify-between items-center p-5 border-t border-slate-200">
                             <div class="flex gap-4">
                                <button class="px-4 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 transition-colors" onclick="restoreDefaultSettings()">Restore Defaults</button>
                             </div>
                             <button class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md" onclick="saveAllSettings()">Save and Close</button>
                        </div>
                    </div>
                </div>`;
            
            // Close modal if backdrop is clicked
            modalContainer.querySelector('.fixed').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
            
            loadWebsiteSettingsPanel();
        }
        
        function switchSettingsTab(tabName, button) {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tabName}Settings`).classList.remove('hidden');
            document.querySelectorAll('.flex.border-b button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-500');
                btn.classList.add('border-transparent', 'text-slate-500', 'hover:text-blue-500');
            });
            button.classList.add('border-blue-500', 'text-blue-500');
            button.classList.remove('border-transparent', 'text-slate-500', 'hover:text-blue-500');
        }

        /**
         * Loads the website settings into the modal panel.
         */
        async function loadWebsiteSettingsPanel() {
            const container = document.getElementById('website-list-container');
            if (!container) return;
            container.innerHTML = '<div class="text-slate-500">Loading websites...</div>';
            try {
                const items = await fetchFromBackend('action=list&path=/');
                if (items && !items.error) {
                    const siteFolders = items.filter(item => item.type === 'folder' && !['.', '..', 'phpmyadmin', 'images'].includes(item.name));
                    const sortedFolders = getSortedWebsites(siteFolders);
                    container.innerHTML = sortedFolders.map(item => {
                        const siteSettings = allSettings.websites[item.name] || {};
                        return `
                        <div class="settings-item bg-slate-50 rounded-lg p-4 mt-4" data-name="${item.name}">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="handle cursor-grab text-slate-400 hover:text-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                                </span>
                                <div class="flex flex-col">
                                    <button onclick="moveToTop(this)" title="Move to Top" class="p-1 text-slate-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg></button>
                                    <button onclick="moveToBottom(this)" title="Move to Bottom" class="p-1 text-slate-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/></svg></button>
                                </div>
                                <h4 class="font-medium text-slate-900 flex-grow">${item.name}</h4>
                            </div>
                            <div class="space-y-4 pl-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Display Name</label><input type="text" data-key="displayName" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.displayName || item.name}"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">Logo Path</label><input type="text" data-key="logoPath" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.logoPath || ''}" placeholder="/${item.name}/logo.png"></div>
                                </div>
                                <div><label class="block text-sm font-medium text-slate-700 mb-1">Description</label><textarea data-key="description" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Fallback description if GitHub repo is not set or has no description.">${siteSettings.description || ''}</textarea></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">External Link URL</label><input type="url" data-key="externalLink" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.externalLink || ''}" placeholder="https://example.com"></div>
                                    <div><label class="block text-sm font-medium text-slate-700 mb-1">External Link Title</label><input type="text" data-key="externalLinkTitle" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.externalLinkTitle || ''}" placeholder="Visit Live Site"></div>
                                </div>
                                <div><label class="block text-sm font-medium text-slate-700 mb-1">GitHub Repo URL</label><input type="url" data-key="githubLink" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.githubLink || ''}" placeholder="https://github.com/user/repo"></div>
                                <div class="pt-2 flex items-center justify-between">
                                    <label class="flex items-center gap-2 text-sm text-slate-700">
                                        <input type="checkbox" data-key="showInternalLink" class="rounded" ${siteSettings.showInternalLink !== false ? 'checked' : ''}>
                                        Show internal link button
                                    </label>
                                    <label class="flex items-center gap-2 text-sm text-slate-700">
                                        <input type="checkbox" data-key="isHidden" class="rounded" ${siteSettings.isHidden ? 'checked' : ''}>
                                        Hide this folder
                                    </label>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                    // Initialize SortableJS
                    new Sortable(container, { handle: '.handle', animation: 150 });
                } else {
                    container.innerHTML = `<div class="text-red-500">Error loading websites: ${items.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('Error loading website settings:', error);
                container.innerHTML = `<div class="text-red-500">Error loading websites: ${error.message}</div>`;
            }
        }
        
        /**
         * Saves all settings from the modal to the server.
         */
        async function saveAllSettings() {
            // Start with a copy of existing settings to preserve theme, etc.
            const newSettings = { ...allSettings };

            // Update general settings
            newSettings.geminiApiKey = document.getElementById('geminiApiKey')?.value || '';
            newSettings.githubToken = document.getElementById('githubToken')?.value || '';
            newSettings.chatbotContext = document.getElementById('chatbotContext')?.value || '';
            
            // Update Glances settings
            newSettings.glances = {
                enabled: document.getElementById('glancesEnabled')?.checked || false,
                url: document.getElementById('glancesUrl')?.value.trim() || ''
            };

            localStorage.setItem('geminiApiKey', newSettings.geminiApiKey);

            // Reset website-specific settings before rebuilding them
            newSettings.websites = newSettings.websites || {};
            newSettings.websitesOrder = [];

            document.querySelectorAll('#website-list-container > .settings-item').forEach(div => {
                const name = div.dataset.name;
                newSettings.websitesOrder.push(name);

                // **BUG FIX**: Preserve existing settings (like AI tags) by starting with them.
                const existingSiteSettings = allSettings.websites[name] || {};
                newSettings.websites[name] = { ...existingSiteSettings };

                // Then, update with values from the form fields.
                div.querySelectorAll('input, textarea').forEach(input => {
                    const key = input.dataset.key;
                    if (key) { // Ensure the element has a data-key attribute
                        const value = input.type === 'checkbox' ? input.checked : input.value;
                        newSettings.websites[name][key] = value;
                    }
                });
            });

            try {
                const response = await fetch('browser.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save_settings', settings: newSettings })
                });
                const result = await response.json();
                if (result.success) {
                    closeModal();
                    location.reload();
                } else {
                    console.error('Failed to save settings:', result.error || 'Unknown error');
                    alert(`Failed to save settings: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving settings:', error.message);
                alert(`Error saving settings: ${error.message}`);
            }
        }

        // --- View Management ---

        /**
         * Toggles between grid and list view.
         */
        function toggleView() {
            currentView = currentView === 'grid' ? 'list' : 'grid';
            localStorage.setItem('dashboardView', currentView);
            updateView();
        }

        /**
         * Updates the UI to reflect the current view state (grid or list).
         */
        function updateView() {
            const gridView = document.getElementById('websites-grid');
            const listView = document.getElementById('websites-list');
            const viewToggleButton = document.getElementById('view-toggle-button');

            if (currentView === 'grid') {
                gridView.classList.remove('hidden');
                listView.classList.add('hidden');
                viewToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>`;
                viewToggleButton.title = "Switch to List View";
            } else {
                gridView.classList.add('hidden');
                listView.classList.remove('hidden');
                viewToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`;
                viewToggleButton.title = "Switch to Grid View";
            }

            // Render content for the new view if it's not already populated
            if (siteDataCache.length > 0) {
                 renderContent(siteDataCache);
            }
        }

        // --- Core Application Logic ---

        /**
         * Sorts website folders based on the saved order in settings (for grid view).
         * @param {Array} siteFolders - Array of folder objects from the backend.
         * @returns {Array} - The sorted array of folder objects.
         */
        function getSortedWebsites(siteFolders) {
            const order = allSettings.websitesOrder || [];
            const sortedSiteFolders = [...siteFolders].sort((a, b) => a.name.localeCompare(b.name));

            return sortedSiteFolders.sort((a, b) => {
                const indexA = order.indexOf(a.name);
                const indexB = order.indexOf(b.name);
                
                if (indexA > -1 && indexB > -1) {
                    return indexA - indexB;
                }
                if (indexA > -1) {
                    return -1;
                }
                if (indexB > -1) {
                    return 1;
                }
                return 0; 
            });
        }

        // --- Content Rendering ---

        /**
         * Renders the main page content based on the current view.
         * @param {Array} siteFolders - Array of folder objects.
         */
        function renderContent(siteFolders) {
            if (currentView === 'grid') {
                renderGridView(siteFolders);
            } else {
                renderListView(siteFolders);
            }
        }
        
        /**
         * Renders the project cards in the grid view.
         * @param {Array} siteFolders - Array of folder objects.
         */
        function renderGridView(siteFolders) {
            const websitesGrid = document.getElementById('websites-grid');
            const sortedFolders = getSortedWebsites(siteFolders);
            websitesGrid.innerHTML = '';
            if (sortedFolders.length === 0) {
                websitesGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center py-10">No website folders found or all are hidden.</p>';
            } else {
                sortedFolders.forEach((folder, index) => {
                    websitesGrid.appendChild(createWebsiteCard({ name: folder.name }, index));
                });
            }
        }

        /**
         * Renders the project list in the spreadsheet-like view.
         * @param {Array} siteFolders - Array of folder objects.
         */
        function renderListView(siteFolders) {
            const websitesList = document.getElementById('websites-list');
            
            const sortedFolders = [...siteFolders].sort((a, b) => {
                const valA = a.name.toLowerCase();
                const valB = b.name.toLowerCase();
                if (valA < valB) return listSortConfig.order === 'asc' ? -1 : 1;
                if (valA > valB) return listSortConfig.order === 'asc' ? 1 : -1;
                return 0;
            });

            const getSortIndicator = (column) => {
                if (listSortConfig.by === column) {
                    return `<span class="ml-1">${listSortConfig.order === 'asc' ? 'â–²' : 'â–¼'}</span>`;
                }
                return '';
            };

            let listHtml = `
                <div class="bg-white border border-slate-200 rounded-xl overflow-hidden">
                    <div class="grid grid-cols-3 gap-4 p-4 font-semibold text-slate-600 bg-slate-50 border-b border-slate-200 text-sm">
                        <div class="col-span-2 cursor-pointer hover:text-blue-500 flex items-center" onclick="setListSort('name')">
                            Project ${getSortIndicator('name')}
                        </div>
                        <div class="text-right">Actions</div>
                    </div>
                    <div>`;

            if (sortedFolders.length === 0) {
                listHtml += '<p class="text-slate-500 text-center p-10">No projects to display.</p>';
            } else {
                sortedFolders.forEach(folder => {
                    listHtml += createWebsiteListItem(folder);
                });
            }

            listHtml += `</div></div>`;
            websitesList.innerHTML = listHtml;
        }

        /**
         * Sets the sorting configuration for the list view and re-renders it.
         * @param {string} sortBy - The key to sort by ('name' or 'updated').
         */
        function setListSort(sortBy) {
            if (listSortConfig.by === sortBy) {
                listSortConfig.order = listSortConfig.order === 'asc' ? 'desc' : 'asc';
            } else {
                listSortConfig.by = sortBy;
                listSortConfig.order = 'asc';
            }
            renderListView(siteDataCache);
        }
        
        /**
         * Creates an HTML element for a single row in the list view.
         * @param {object} siteData - The data for the website.
         * @returns {string} - The HTML string for the list item.
         */
        function createWebsiteListItem(siteData) {
            const siteSettings = allSettings.websites[siteData.name] || {};
            const displayName = siteSettings.displayName || siteData.name;
            
            const logoSrc = siteSettings.logoPath || `/${siteData.name}/logo.png`;
            const placeholderHtml = `<div class='w-6 h-6 rounded-md flex items-center justify-center overflow-hidden bg-slate-200 text-xs font-bold text-slate-500'>${displayName.charAt(0).toUpperCase()}</div>`;
            const logoHtml = `
                <div class="w-6 h-6 mr-3 flex-shrink-0">
                    <img src="${logoSrc}" alt="${displayName} Logo" class="w-full h-full object-contain rounded-md" 
                         onerror="this.parentElement.innerHTML = '${placeholderHtml}'">
                </div>`;

            const showInternal = siteSettings.showInternalLink !== false;
            const externalLink = siteSettings.externalLink;
            const externalTitle = siteSettings.externalLinkTitle || 'Visit Link';
            const githubLink = siteSettings.githubLink;
            let buttonsHtml = '';

            if (showInternal) {
                buttonsHtml += `<a href="/${siteData.name}/" target="_blank" class="px-3 py-1 text-sm bg-slate-200 text-slate-800 font-medium rounded-md hover:bg-slate-300 transition-colors">Local</a>`;
            }
            if (externalLink) {
                buttonsHtml += `<a href="${externalLink}" target="_blank" class="px-3 py-1 text-sm bg-blue-100 text-blue-800 font-medium rounded-md hover:bg-blue-200 transition-colors">${externalTitle}</a>`;
            }
            if (githubLink) {
                buttonsHtml += `<a href="${githubLink}" target="_blank" class="px-3 py-1 text-sm bg-gray-800 text-white font-medium rounded-md hover:bg-gray-900 transition-colors">GitHub</a>`;
            }
            buttonsHtml += `<button onclick="openCodebaseChat('${siteData.name}')" class="px-3 py-1 text-sm bg-indigo-100 text-indigo-800 font-medium rounded-md hover:bg-indigo-200 transition-colors">Ask AI</button>`;

            return `
                <div class="grid grid-cols-3 gap-4 p-4 items-center border-b border-slate-200 last:border-b-0 hover:bg-slate-50 transition-colors duration-150">
                    <div class="col-span-2 font-medium text-slate-900 flex items-center">
                        ${logoHtml}
                        <span>${displayName}</span>
                    </div>
                    <div class="flex justify-end items-center gap-2">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
        }

        /**
         * Creates an HTML card element for a website.
         * @param {object} siteData - The data for the website.
         * @param {number} index - The index of the card for animation delay.
         * @returns {HTMLElement} - The card element.
         */
        function createWebsiteCard(siteData, index) {
            const card = document.createElement('div');
            card.className = 'card-animated bg-white p-6 rounded-xl hover:scale-105 border border-slate-200 hover:border-blue-500 transition-all duration-300 flex flex-col';
            card.style.animationDelay = `${index * 50}ms`;
            card.id = `card-${siteData.name}`;

            const siteSettings = allSettings.websites[siteData.name] || {};
            const displayName = siteSettings.displayName || siteData.name;
            const description = siteSettings.githubDescription || siteSettings.description || 'A local development project.';
            const tags = siteSettings.tags || [];
            const logoSrc = siteSettings.logoPath || `/${siteData.name}/logo.png`;
            const placeholderHtml = `<div class='w-24 h-24 rounded-full flex items-center justify-center overflow-hidden bg-slate-100'><span class='text-4xl font-bold text-slate-500'>${displayName.charAt(0).toUpperCase()}</span></div>`;
            const logoContainerHtml = `
                <div class="w-24 h-24 mb-4 flex items-center justify-center">
                    <img src="${logoSrc}" alt="${displayName} Logo" class="max-w-full max-h-full object-contain" 
                         onerror="this.parentElement.innerHTML = '${placeholderHtml}'">
                </div>`;
            
            const tagsHtml = tags.length > 0 ? `
                <div class="flex flex-wrap justify-center gap-2 mt-2">
                    ${tags.map(tag => `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${tag}</span>`).join('')}
                </div>` : '';

            const showInternal = siteSettings.showInternalLink !== false;
            const externalLink = siteSettings.externalLink;
            const externalTitle = siteSettings.externalLinkTitle || 'Visit Link';
            const githubLink = siteSettings.githubLink;
            let buttonsHtml = '';
            let mainButtonHtml = '';
            let iconButtonsHtml = '';

            if (externalLink) {
                 mainButtonHtml = `<a href="${externalLink}" target="_blank" class="flex-1 block text-center px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all duration-200">${externalTitle}</a>`;
            } else if (showInternal) {
                 mainButtonHtml = `<a href="/${siteData.name}/" target="_blank" class="flex-1 block text-center px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all duration-200">Visit Local</a>`;
            }

            if (externalLink && showInternal) {
                iconButtonsHtml += `<a href="/${siteData.name}/" target="_blank" title="Visit Local" class="p-3 bg-slate-200 text-slate-800 hover:bg-slate-300 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                </a>`;
            }
            if (githubLink) {
                iconButtonsHtml += `<a href="${githubLink}" target="_blank" title="View on GitHub" class="p-3 bg-slate-200 text-slate-800 hover:bg-slate-300 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
                </a>`;
            }

            buttonsHtml = mainButtonHtml;
            if (iconButtonsHtml) {
                buttonsHtml = `<div class="flex items-center gap-2">${mainButtonHtml}${iconButtonsHtml}</div>`;
            }

            let footerHtml = '';
            if (buttonsHtml) {
                footerHtml = `<div class="mt-4 pt-4 border-t border-slate-200">
                                <div class="flex items-center gap-3">${buttonsHtml}</div>
                              </div>`;
            }
            
            const aiFeaturesHtml = `
                <div class="mt-4 pt-4 border-t border-slate-200 flex flex-col sm:flex-row gap-2">
                    <button onclick="openCodebaseChat('${siteData.name}')" class="w-full text-sm px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg>
                        Ask Codebase
                    </button>
                </div>
            `;

            card.innerHTML = `
                <div class="flex-grow flex flex-col items-center text-center">
                    ${logoContainerHtml}
                    <h3 class="text-xl font-bold text-slate-900">${displayName}</h3>
                    <p class="text-sm text-slate-500 mt-2 h-10">${description}</p>
                    ${tagsHtml}
                </div>
                ${aiFeaturesHtml}
                ${footerHtml}`;
            return card;
        }

        /**
         * Fetches descriptions and topics (tags) from GitHub for projects that have a repo link.
         */
        async function fetchGitHubDataForProjects() {
            const token = allSettings.githubToken;
            if (!token) {
                console.warn("GitHub token not set. Skipping GitHub data fetch.");
                return;
            }

            const promises = [];
            const siteNamesWithLinks = [];

            if (!allSettings.websites) {
                allSettings.websites = {};
            }

            for (const siteName in allSettings.websites) {
                const site = allSettings.websites[siteName];
                if (site && site.githubLink) {
                    const match = site.githubLink.match(/github\.com\/([^\/]+\/[^\/]+)/);
                    if (match && match[1]) {
                        const repoPath = match[1].replace('.git', '');
                        const url = `https://api.github.com/repos/${repoPath}`;
                        promises.push(
                            fetch(url, {
                                headers: { 'Authorization': `token ${token}` }
                            }).then(res => {
                                if (!res.ok) {
                                    return Promise.reject(new Error(`GitHub API Error: ${res.status} ${res.statusText}`));
                                }
                                return res.json();
                            })
                        );
                        siteNamesWithLinks.push(siteName);
                    }
                }
            }

            if (promises.length === 0) return;

            const results = await Promise.allSettled(promises);

            results.forEach((result, index) => {
                const siteName = siteNamesWithLinks[index];
                if (!allSettings.websites[siteName]) {
                    allSettings.websites[siteName] = {};
                }

                if (result.status === 'fulfilled') {
                    const repoData = result.value;
                    
                    if (repoData.description) {
                        allSettings.websites[siteName].githubDescription = repoData.description;
                    } else {
                        delete allSettings.websites[siteName].githubDescription;
                    }
                    
                    if (repoData.topics && repoData.topics.length > 0) {
                        allSettings.websites[siteName].tags = repoData.topics;
                    } else {
                        delete allSettings.websites[siteName].tags;
                    }
                } else {
                    console.warn(`Failed to fetch GitHub data for ${siteName}:`, result.reason.message);
                    delete allSettings.websites[siteName].githubDescription;
                    delete allSettings.websites[siteName].tags;
                }
            });
        }


        /**
         * Fetches initial data and renders the page.
         */
        async function renderPage() {
            const websitesGrid = document.getElementById('websites-grid');
            websitesGrid.innerHTML = '<p class="text-slate-500 col-span-full">Loading projects...</p>';
            
            await fetchGitHubDataForProjects();
            
            try {
                const items = await fetchFromBackend('action=list&path=/');
                if (items && !items.error) {
                    siteDataCache = items.filter(item => {
                        const settings = allSettings.websites && allSettings.websites[item.name];
                        const isHidden = settings && settings.isHidden;
                        const isExcluded = ['.', '..', 'phpmyadmin', 'images'].includes(item.name);
                        return item.type === 'folder' && !isHidden && !isExcluded;
                    });
                    renderContent(siteDataCache);
                } else {
                    websitesGrid.innerHTML = `<p class="text-red-500 col-span-full">Could not load websites. Please ensure your backend is running.</p>`;
                }
            } catch (e) {
                websitesGrid.innerHTML = `<p class='text-red-500 font-bold col-span-full'>Error loading websites: ${e.message}</p>`;
            }
        }
        
        // --- Gemini Chatbot & AI Features ---

        async function openCodebaseChat(projectName) {
            openChatbot(projectName);
        }

        async function openChatbot(projectName = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            const title = projectName ? `Code Assistant: '${projectName}'` : 'Server Assistant';
            
            let modalHtml = `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center sm:items-center z-50 animate-fadeIn" onclick="if (event.target === this) closeModal()">
                    <div class="modal-content bg-white rounded-t-lg sm:rounded-lg shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col animate-scaleIn">
                        <div class="flex justify-between items-center p-4 border-b border-slate-200">
                            <h2 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg>
                                ${title}
                            </h2>
                            <button class="text-slate-500 hover:text-blue-500 transition-colors" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                        <div class="flex-grow flex overflow-hidden">
                            ${projectName ? `
                            <div class="w-1/3 border-r border-slate-200 overflow-y-auto p-2">
                                <div id="file-browser" class="text-sm">Loading files...</div>
                            </div>
                            <div id="code-chat-view" class="w-2/3 flex flex-col">
                                <div id="file-content-view" class="flex-grow p-4 overflow-y-auto bg-slate-50">
                                    <p class="text-slate-500">Select a file to view its content or ask a question about the project below.</p>
                                </div>
                                <div id="refactor-button-container" class="p-2 border-t border-slate-200 hidden">
                                    <button id="refactor-btn" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md">Analyze & Refactor File</button>
                                </div>
                            ` : `
                            <div id="code-chat-view" class="w-full flex flex-col">
                            `}
                                <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
                                <div class="p-4 border-t border-slate-200">
                                    <form id="chat-form" class="flex items-center gap-3">
                                        <input type="text" id="chat-input" class="flex-grow px-3 py-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ask about your server...">
                                        <button type="submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11zM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493z"/></svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            modalContainer.innerHTML = modalHtml;
            chatHistory = [];
            renderChatHistory();
            
            if (projectName) {
                loadProjectFiles(projectName);
            }

            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessageToGemini(projectName);
            });
        }

        function renderChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;

            messagesContainer.innerHTML = '';
            chatHistory.forEach(msg => {
                const messageEl = document.createElement('div');
                if (msg.role === 'user') {
                    messageEl.className = 'flex justify-end';
                    messageEl.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs sm:max-w-md">${msg.parts[0].text}</div>`;
                } else {
                    messageEl.className = 'flex justify-start';
                    messageEl.innerHTML = `<div class="bg-slate-200 p-3 rounded-lg max-w-xs sm:max-w-md">${msg.parts[0].text}</div>`;
                }
                messagesContainer.appendChild(messageEl);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessageToGemini(projectName = null) {
            const input = document.getElementById('chat-input');
            const userInput = input.value.trim();
            if (!userInput) return;

            const apiKey = allSettings.geminiApiKey;
            if (!apiKey) {
                alert('Please set your Gemini API Key in the settings first.');
                return;
            }

            chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            renderChatHistory();
            input.value = '';

            const messagesContainer = document.getElementById('chat-messages');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'flex justify-start';
            loadingEl.innerHTML = `<div class="bg-slate-200 p-3 rounded-lg"><span class="animate-pulse">...</span></div>`;
            messagesContainer.appendChild(loadingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            let systemPrompt = '';

            if (projectName) {
                let projectContext = `Could not fetch context for project ${projectName}.`;
                try {
                    const { fileList, fileContents } = await getProjectContext(projectName);
                    let contentSection = `The contents of the key files could not be read from the server. Please ask the user to provide the file content if you need it.`;
                    if (fileContents && fileContents.trim() !== '') {
                        contentSection = `Here are the contents of some of the key files:\n${fileContents}`;
                    }
                    projectContext = `Here is the file structure for the project '${projectName}':\n${fileList}\n\n${contentSection}`;
                } catch (e) { 
                    console.error(`Could not fetch context for ${projectName}.`, e); 
                }
                systemPrompt = `You are a helpful code assistant. You are answering questions about a specific project named '${projectName}'.\n\n${projectContext}\n\nAnswer the user's questions based on this file structure and content.`;
            } else {
                let fileList = 'No project folder list available.';
                try {
                    const items = await fetchFromBackend('action=list&path=/');
                    if (items && !items.error) {
                        fileList = "Here is a list of project folders on the server:\n - " + items.map(i => i.name).join('\n - ');
                    }
                } catch (e) { console.error("Could not fetch file list for chatbot context."); }

                const baseContext = "You are a helpful server assistant.";
                const customContext = allSettings.chatbotContext || "No additional context provided.";
                systemPrompt = `${baseContext}\n\n${fileList}\n\nAdditional user-provided context:\n${customContext}`;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: {
                            parts: [{ text: systemPrompt }]
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const botResponse = result.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                
            } catch (error) {
                console.error('Gemini API Error:', error);
                chatHistory.push({ role: "model", parts: [{ text: `Sorry, I encountered an error: ${error.message}` }] });
            } finally {
                loadingEl.remove();
                renderChatHistory();
            }
        }

        async function loadProjectFiles(projectName) {
            const fileBrowser = document.getElementById('file-browser');
            try {
                const files = await fetchFromBackend(`action=list_recursive&path=/${projectName}/`);
                if (files.error) throw new Error(files.error);
                
                fileBrowser.innerHTML = files.map(file => `
                    <div class="p-2 hover:bg-slate-100 rounded-md cursor-pointer" onclick="loadFileContent('${projectName}', '${file.name}')">
                        ${file.name}
                    </div>
                `).join('');
            } catch (error) {
                fileBrowser.innerHTML = `<p class="text-red-500 p-2">Error loading files: ${error.message}</p>`;
            }
        }
        
        async function loadFileContent(projectName, filePath) {
            const fileContentDiv = document.getElementById('file-content-view');
            const refactorContainer = document.getElementById('refactor-button-container');
            fileContentDiv.innerHTML = `<p class="text-slate-500 animate-pulse">Loading ${filePath}...</p>`;
            refactorContainer.classList.add('hidden');
            
            try {
                const fullPath = `${projectName}/${filePath}`;
                const result = await fetchFromBackend(`action=get_content&path=${encodeURIComponent(fullPath)}`);
                if (result.error) throw new Error(result.error);
                
                fileContentDiv.innerHTML = `<pre class="text-sm whitespace-pre-wrap"><code>${escapeHtml(result.content)}</code></pre>`;
                refactorContainer.classList.remove('hidden');
                document.getElementById('refactor-btn').onclick = () => initiateRefactoring(projectName, filePath, result.content);

            } catch (error) {
                fileContentDiv.innerHTML = `<p class="text-red-500">Error loading file: ${error.message}</p>`;
            }
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        
        async function initiateRefactoring(projectName, filePath, originalContent) {
            const apiKey = allSettings.geminiApiKey;
            if (!apiKey) {
                alert('Please set your Gemini API Key in the settings first.');
                return;
            }

            const btn = document.getElementById('refactor-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Analyzing...</span>';

            const truncatedContent = originalContent.substring(0, 8000);

            const prompt = `
                You are an expert programmer performing a code review on the following code from the file "${filePath}".
                
                Your task is to analyze the code for clarity, efficiency, and best practices, then provide a refactored version.

                You MUST return a clean JSON object and NOTHING ELSE. Do not include Markdown fences like \`\`\`json, explanations, or any text outside of the JSON object.
                The JSON response must strictly adhere to the following schema:
                {
                  "refactored_code": "string",
                  "explanation": "string containing a concise, bulleted list in Markdown explaining the key changes.",
                  "is_refactored": boolean
                }
                
                Respond with only the raw JSON object so it can be parsed reliably.

                Original Code to analyze:
                \`\`\`
                ${truncatedContent}
                \`\`\`
            `;

            try {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                
                try {
                    const rawText = result.candidates[0].content.parts[0].text;
                    
                    // Find the JSON block, which might be wrapped in markdown fences or other text
                    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch || !jsonMatch[0]) {
                        throw new Error("No valid JSON object found in the AI response.");
                    }
                    
                    const jsonString = jsonMatch[0];
                    const refactorData = JSON.parse(jsonString);
                    displayRefactorModal(truncatedContent, refactorData.refactored_code, refactorData.explanation, refactorData.is_refactored);
                } catch (parseError) {
                    console.error("Failed to parse AI response as JSON:", parseError);
                    console.log("Raw AI Response:", result.candidates[0].content.parts[0].text);
                    alert("The AI returned a response that could not be read. Please check the console for more details.");
                }

            } catch (error) {
                alert(`An error occurred during refactoring: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Analyze & Refactor File';
            }
        }

        function displayRefactorModal(originalCode, refactoredCode, explanation, isRefactored) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden'); // Ensure it's visible
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn';
            modal.innerHTML = `
                <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col animate-scaleIn">
                    <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-slate-200">
                        <h2 class="text-lg font-semibold text-slate-900">Refactoring Suggestions</h2>
                        <button class="text-slate-500 hover:text-blue-500 transition-colors" onclick="this.closest('.fixed').remove()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    
                    <div class="flex-grow flex flex-col p-4 overflow-hidden gap-4">
                        <!-- Code Comparison Section -->
                        <div class="h-2/3 grid grid-cols-1 md:grid-cols-2 gap-4" style="min-height: 0;">
                            <div class="flex flex-col" style="min-height: 0;">
                                <h3 class="font-semibold mb-2">Original Code</h3>
                                <div class="flex-grow bg-slate-100 rounded-lg overflow-auto p-2"><pre class="text-sm whitespace-pre-wrap"><code>${escapeHtml(originalCode)}</code></pre></div>
                            </div>
                            <div class="flex flex-col" style="min-height: 0;">
                                <h3 class="font-semibold mb-2">Refactored Code</h3>
                                <div class="flex-grow bg-slate-100 rounded-lg overflow-auto p-2"><pre class="text-sm whitespace-pre-wrap"><code>${escapeHtml(refactoredCode)}</code></pre></div>
                            </div>
                        </div>
                        
                        <!-- Explanation Section -->
                        <div class="h-1/3 flex flex-col border-t border-slate-200 pt-4" style="min-height: 0;">
                            <h3 class="font-semibold mb-2">Explanation of Changes</h3>
                            <div class="flex-grow bg-slate-100 rounded-lg overflow-auto p-2">
                                <div class="text-sm prose max-w-none">${isRefactored ? explanation : '<p>No changes were needed. The original code is already well-structured.</p>'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.appendChild(modal);
        }
        
        async function getProjectContext(projectName) {
            const files = await fetchFromBackend(`action=list_recursive&path=/${projectName}/`);
            if (files.error) throw new Error(files.error);

            const fileList = files.map(f => f.name).join('\n');
            let fileContents = [];
            
            const importantFileBasenames = ['index.html', 'index.php', 'package.json', 'composer.json', 'README.md', 'app.js', 'main.js', 'style.css'];
            const importantFilesFound = files.filter(fileObj => {
                const basename = (fileObj.name || '').split('/').pop();
                return importantFileBasenames.includes(basename);
            });

            for (const fileObj of importantFilesFound) {
                const filePath = `${projectName}/${fileObj.name}`;
                try {
                    const content = await fetchFromBackend(`action=get_content&path=${encodeURIComponent(filePath)}`);
                    if (content && !content.error) {
                        fileContents.push(`--- Content of ${fileObj.name} ---\n${content.content.substring(0, 2000)}\n---`);
                    } else {
                        console.warn(`Could not fetch content for ${filePath}:`, content.error);
                    }
                } catch (e) { console.warn(`Error fetching content for ${filePath}`, e); }
            }
            
            return { fileList, fileContents: fileContents.join('\n\n') };
        }

        async function refreshAllGitHubData() {
            const btn = document.getElementById('refresh-github-btn');
            if (!btn) return;

            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Refreshing...</span>';

            try {
                await fetchGitHubDataForProjects();
                await saveAllSettingsAndReload();
            } catch (error) {
                console.error('Failed to refresh GitHub data:', error);
                alert('Failed to refresh GitHub data. Check the console for details.');
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }
        
        async function saveAllSettingsAndReload() {
             try {
                const response = await fetch('browser.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save_settings', settings: allSettings })
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    console.error('Failed to save settings:', result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error saving settings:', error.message);
            }
        }
        
        function backupAllProjects() {
            const btn = document.getElementById('backup-all-btn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Creating backup...</span>';
            
            window.location.href = 'browser.php?action=backup_all';

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }, 3000);
        }

        // --- GitHub Backup Functions (from GitVault logic) ---

        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        function createApiHeaders(token) {
            const headers = new Headers();
            headers.append('Authorization', `Bearer ${token}`);
            headers.append('Accept', 'application/vnd.github+json');
            return headers;
        }

        async function fetchWithRetry(fn, retries, delayMs, repoName) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    console.warn(`   -> For ${repoName}, attempt ${i + 1} failed. Retrying in ${delayMs / 1000}s...`);
                    await delay(delayMs);
                }
            }
            throw lastError;
        }

        async function fetchAllGitHubRepos(token) {
            let allRepos = [];
            let page = 1;
            let hasNextPage = true;
            while (hasNextPage) {
                const apiUrl = `${PROXY_URL}https://api.github.com/user/repos?type=all&per_page=100&page=${page}`;
                const response = await fetch(apiUrl, { headers: createApiHeaders(token) });
                if (!response.ok) throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                const repos = await response.json();
                if (repos.length === 0) {
                    hasNextPage = false;
                } else {
                    const repoData = repos.map(repo => ({
                        name: repo.full_name.replace('/', '_'),
                        url: repo.url
                    }));
                    allRepos = allRepos.concat(repoData);
                    page++;
                }
            }
            return allRepos;
        }

        async function fetchBinary(url, token) {
            const proxiedUrl = `${PROXY_URL}${url}`;
            const response = await fetch(proxiedUrl, { headers: createApiHeaders(token) });
            if (!response.ok) throw new Error(`(${response.status}) Failed to download file`);
            return await response.blob();
        }

        async function backupGitHubRepos() {
            const btn = document.getElementById('backup-github-btn');
            const originalBtnText = btn.innerHTML;
            const token = allSettings.githubToken;

            if (!token) {
                alert('Please set your GitHub Token in the General settings tab first.');
                return;
            }

            btn.disabled = true;

            try {
                btn.innerHTML = '<span class="animate-pulse">Fetching repository list...</span>';
                const repos = await fetchAllGitHubRepos(token);
                
                if (repos.length === 0) {
                    alert('No repositories found for your account.');
                    btn.disabled = false;
                    btn.innerHTML = originalBtnText;
                    return;
                }

                const zip = new JSZip();
                let downloadedCount = 0;
                const totalRepos = repos.length;

                for (let i = 0; i < totalRepos; i++) {
                    const repo = repos[i];
                    btn.innerHTML = `<span class="animate-pulse">Downloading ${i + 1}/${totalRepos}: ${repo.name}...</span>`;
                    
                    try {
                        const zipballUrl = `${repo.url}/zipball`;
                        const repoZipBlob = await fetchWithRetry(() => fetchBinary(zipballUrl, token), 3, 1000, repo.name);
                        zip.file(`${repo.name}.zip`, repoZipBlob);
                        downloadedCount++;
                    } catch (error) {
                        console.error(`Failed to download ${repo.name} after multiple attempts. Skipping. Reason: ${error.message}`);
                        zip.file(`${repo.name}-DOWNLOAD_FAILED.txt`, `Could not download this repository. It might be empty or protected.`);
                    }
                }

                if (downloadedCount > 0) {
                    btn.innerHTML = '<span class="animate-pulse">Compressing backup...</span>';
                    const content = await zip.generateAsync({ type: "blob" });
                    const date = new Date().toISOString().slice(0, 10);
                    saveAs(content, `github-backup-${date}.zip`);
                } else {
                     alert('Backup failed: No repositories could be downloaded.');
                }

            } catch (error) {
                console.error('GitHub backup failed:', error);
                alert(`An error occurred during the GitHub backup: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }
        
        /**
         * Opens the Glances URL in a modal.
         */
        function openGlancesModal() {
            const glancesUrl = allSettings.glances?.url;
            if (!glancesUrl) {
                console.error("Glances URL is not set.");
                return;
            }
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn">
                    <div class="modal-content bg-slate-100 rounded-lg shadow-2xl w-full h-full max-w-7xl max-h-[90vh] flex flex-col animate-scaleIn">
                        <!-- Modal Header -->
                        <div class="flex justify-between items-center p-4 border-b border-slate-200 bg-white rounded-t-lg">
                            <h2 class="text-lg font-semibold text-slate-900">Glances System Monitor</h2>
                            <div class="flex items-center gap-2">
                                <a href="${glancesUrl}" target="_blank" class="text-slate-500 hover:text-blue-500 transition-colors" title="Open in new tab">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                                </a>
                                <button class="text-slate-500 hover:text-blue-500 transition-colors" onclick="closeModal()">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                        <!-- Modal Body -->
                        <div class="flex-grow p-2 bg-slate-100 rounded-b-lg">
                            <iframe src="${glancesUrl}" class="w-full h-full border-0 rounded-md"></iframe>
                        </div>
                    </div>
                </div>`;
            
            // Close modal if backdrop is clicked
            modalContainer.querySelector('.fixed').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
        }

        /**
         * Fetches and updates the Glances system statistics.
         */
        async function refreshGlancesStats() {
            if (!allSettings.glances || !allSettings.glances.enabled) {
                document.getElementById('glances-stats').classList.add('hidden');
                if (glancesInterval) {
                    clearInterval(glancesInterval);
                    glancesInterval = null;
                }
                return;
            }
            document.getElementById('glances-stats').classList.remove('hidden');

            try {
                const [quicklookRes, fsRes] = await Promise.all([
                    fetch('/glances.php?p=quicklook'),
                    fetch('/glances.php?p=fs')
                ]);

                if (!quicklookRes.ok) throw new Error(`Quicklook fetch failed: ${quicklookRes.status}`);
                if (!fsRes.ok) throw new Error(`Filesystem fetch failed: ${fsRes.status}`);

                const quicklookData = await quicklookRes.json();
                const fsData = await fsRes.json();

                if (quicklookData.error) throw new Error(quicklookData.error);
                if (fsData.error) throw new Error(fsData.error);

                // Update CPU
                if (quicklookData.cpu && typeof quicklookData.cpu !== 'undefined') {
                    const cpuUsage = quicklookData.cpu.toFixed(1);
                    document.getElementById('cpu-usage').textContent = cpuUsage;
                    document.getElementById('cpu-bar').style.width = `${cpuUsage}%`;
                }

                // Update Memory
                if (quicklookData.mem && typeof quicklookData.mem !== 'undefined') {
                    const memUsage = quicklookData.mem.toFixed(1);
                    document.getElementById('mem-usage').textContent = memUsage;
                    document.getElementById('mem-bar').style.width = `${memUsage}%`;
                }
                
                // Update Disk Usage
                const rootFs = fsData.find(fs => fs.mnt_point === '/');
                if (rootFs && typeof rootFs.percent !== 'undefined') {
                     const diskUsage = rootFs.percent.toFixed(1);
                     document.getElementById('disk-usage').textContent = diskUsage;
                     document.getElementById('disk-bar').style.width = `${diskUsage}%`;
                }

            } catch (error) {
                console.error('Could not fetch Glances stats:', error.message);
                ['cpu-usage', 'mem-usage', 'disk-usage'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = 'N/A';
                });
                 ['cpu-bar', 'mem-bar', 'disk-bar'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.width = '0%';
                });
            }
        }


        document.addEventListener('DOMContentLoaded', async function() {
            const styleSheet = document.createElement("style");
            styleSheet.type = "text/css";
            styleSheet.innerText = `
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
                @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
                .animate-fadeOut { animation: fadeOut 0.3s ease-in forwards; }
                @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                .animate-scaleIn { animation: scaleIn 0.3s ease-out forwards; }
            `;
            document.head.appendChild(styleSheet);

            // Set up view toggle
            currentView = localStorage.getItem('dashboardView') || 'grid';
            document.getElementById('view-toggle-button').addEventListener('click', toggleView);
            updateView();

            try {
                const response = await fetch('settings.json?t=' + new Date().getTime());
                if (response.ok) {
                     allSettings = await response.json();
                } else {
                     allSettings = { websites: {}, websitesOrder: [] };
                }
            } catch (e) {
                console.warn("settings.json not found or invalid, using defaults.");
                allSettings = { websites: {}, websitesOrder: [] };
            }
            
            const storedApiKey = localStorage.getItem('geminiApiKey');
            if (storedApiKey) {
                allSettings.geminiApiKey = storedApiKey;
            }
            
            await renderPage();
            
            // Show Glances modal link if URL is set
            if (allSettings.glances?.url) {
                document.getElementById('glances-link-container').classList.remove('hidden');
            }

            // Initial call and interval for Glances stats
            if (allSettings.glances && allSettings.glances.enabled) {
                refreshGlancesStats();
                glancesInterval = setInterval(refreshGlancesStats, 2000);
            }
        });
    </script>
</body>
</ht
