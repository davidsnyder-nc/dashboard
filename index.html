<!DOCTYPE html>
<html lang="en" class=""> <!-- Add class="dark" here to enable dark mode by default -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localhost Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display.swap" rel="stylesheet">
    
    <!-- SortableJS for drag-and-drop in settings -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- JSZip for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- CodeMirror for code editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/php/php.min.js"></script>

    <!-- Favicon: Prevents console errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <style>
        /* Use Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom animation for cards appearing */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Apply animation to cards */
        .card-animated { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; border: 3px solid transparent; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(100, 116, 139, 0.5); }

        /* Styles for SortableJS drag-and-drop placeholders */
        .sortable-ghost { background: rgba(59, 130, 246, 0.1); border: 2px dashed rgba(59, 130, 246, 0.5); opacity: 0.7; }
        .sortable-chosen { cursor: grabbing; }

        /* CodeMirror styling */
        .CodeMirror { height: 100%; font-size: 14px; }
        
        /* File tree styling */
        .file-tree-item { display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-gray-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- Main Application Container -->
    <div id="app-container" class="min-h-screen">
        
        <!-- Header -->
        <header class="sticky top-0 z-30 backdrop-blur-lg bg-slate-50/80 dark:bg-gray-900/80 border-b border-slate-200 dark:border-gray-700">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <!-- Title -->
                    <div class="flex items-center gap-4">
                        <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
                            web.<span class="text-blue-500">server</span>
                        </h1>
                    </div>
                    <!-- Header Buttons -->
                    <div class="flex items-center gap-2">
                        <!-- Dark Mode Toggle -->
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors" title="Toggle Theme">
                            <!-- Icon will be set by JS -->
                        </button>
                        <!-- Glances Link -->
                        <div id="glances-link-container" class="hidden">
                            <button onclick="openGlancesModal()" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors" title="Open Glances">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                            </button>
                        </div>
                        <!-- View Toggle Button -->
                        <button id="view-toggle-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors" title="Switch View">
                            <!-- Icon will be set by JS -->
                        </button>
                        <!-- Settings Button -->
                        <button id="settings-button" onclick="openSettings()" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors" title="Settings">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <!-- Search and Filter Bar -->
            <div class="mb-8">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search projects by name or tag..." class="w-full pl-10 pr-4 py-3 bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-full focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Glances System Stats -->
            <div id="glances-stats" class="mb-10 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- CPU Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-slate-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-300 mb-2">CPU</h3>
                        <div class="flex items-baseline justify-between"><span id="cpu-usage" class="text-4xl font-bold text-slate-800 dark:text-white">...</span><span class="text-2xl font-medium text-slate-500 dark:text-slate-400">%</span></div>
                        <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2.5 mt-4"><div id="cpu-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <!-- Memory Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-slate-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-300 mb-2">Memory</h3>
                        <div class="flex items-baseline justify-between"><span id="mem-usage" class="text-4xl font-bold text-slate-800 dark:text-white">...</span><span class="text-2xl font-medium text-slate-500 dark:text-slate-400">%</span></div>
                        <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2.5 mt-4"><div id="mem-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                    <!-- Disk Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-slate-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-300 mb-2">Disk</h3>
                        <div class="flex items-baseline justify-between"><span id="disk-usage" class="text-4xl font-bold text-slate-800 dark:text-white">...</span><span class="text-2xl font-medium text-slate-500 dark:text-slate-400">%</span></div>
                        <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2.5 mt-4"><div id="disk-bar" class="bg-purple-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>

            <!-- Website Grid -->
            <div id="websites-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Website cards will be injected here by JavaScript -->
            </div>
            
            <!-- Website List (Spreadsheet View) -->
            <div id="websites-list" class="hidden">
                <!-- List view will be injected here -->
            </div>
        </main>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container" class="hidden"></div>
    
    <!-- Gemini Chatbot FAB -->
    <button onclick="openChatbot()" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-110 z-40">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </button>

    <script>
        // --- Global State ---
        let allSettings = {};
        let chatHistory = [];
        let glancesInterval;
        let currentView = 'grid';
        let listSortConfig = { by: 'name', order: 'asc' };
        let siteDataCache = [];
        const PROXY_URL = 'https://corsproxy.io/?';
        let codeEditor; // For CodeMirror instance

        // --- Utility Functions ---

        async function fetchFromBackend(params, options = {}) {
            try {
                const response = await fetch(`browser.php?${params}`, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching from backend:', error);
                return { error: error.message };
            }
        }
        
        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            const modal = modalContainer.querySelector('.modal-content');
            if (modal) {
                modal.classList.add('animate-fadeOut');
                modal.parentElement.classList.add('animate-fadeOut');
                setTimeout(() => {
                    modalContainer.innerHTML = '';
                    modalContainer.classList.add('hidden');
                }, 300);
            }
        }

        // --- Settings Modal ---

        function moveToTop(button) {
            const item = button.closest('.settings-item');
            if (item) item.parentElement.prepend(item);
        }

        function moveToBottom(button) {
            const item = button.closest('.settings-item');
            if (item) item.parentElement.appendChild(item);
        }

        function restoreDefaultSettings() {
            allSettings.websitesOrder = [];
            if (allSettings.websites) {
                for (const siteName in allSettings.websites) {
                    if (allSettings.websites.hasOwnProperty(siteName)) {
                        allSettings.websites[siteName].isHidden = false;
                    }
                }
            }
            loadWebsiteSettingsPanel();
        }

        function openSettings() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            const glancesSettings = allSettings.glances || {};
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn">
                    <div id="settingsModal" class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col animate-scaleIn">
                        <div class="flex justify-between items-center p-5 border-b border-slate-200 dark:border-gray-700">
                            <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Dashboard Settings</h2>
                            <button class="text-slate-500 dark:text-slate-400 hover:text-blue-500 transition-colors" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                        <div class="flex border-b border-slate-200 dark:border-gray-700 px-6">
                            <button class="py-3 px-4 font-medium text-sm border-b-2 border-blue-500 text-blue-500" onclick="switchSettingsTab('websites', this)">Websites</button>
                            <button class="py-3 px-4 font-medium text-sm border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-blue-500" onclick="switchSettingsTab('general', this)">General</button>
                            <button class="py-3 px-4 font-medium text-sm border-b-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-blue-500" onclick="switchSettingsTab('backup', this)">Backup</button>
                        </div>
                        <div id="websitesSettings" class="settings-tab-content flex-grow overflow-y-auto p-6 space-y-4">
                             <div class="p-4 bg-slate-100 dark:bg-gray-700 rounded-lg">
                                <h3 class="font-semibold mb-2 text-slate-800 dark:text-slate-200">GitHub Sync</h3>
                                <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Fetch the latest descriptions and repository topics (tags) for all projects linked to a GitHub repository.</p>
                                <button id="refresh-github-btn" onclick="refreshAllGitHubData()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">Refresh GitHub Data</button>
                            </div>
                            <div id="website-list-container"></div>
                        </div>
                        <div id="generalSettings" class="settings-tab-content flex-grow overflow-y-auto p-6 space-y-4 hidden">
                            <div class="p-4 bg-slate-100 dark:bg-gray-700 rounded-lg">
                                <h3 class="font-semibold mb-2 text-slate-800 dark:text-slate-200">Glances System Monitor</h3>
                                <div class="space-y-4">
                                    <div><label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300"><input type="checkbox" id="glancesEnabled" class="rounded" ${glancesSettings.enabled ? 'checked' : ''}> Enable On-Page System Monitor</label><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Requires the <code>glances.php</code> file to be present on your server.</p></div>
                                    <div class="pt-2"><label for="glancesUrl" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">External Glances URL (optional)</label><input type="url" id="glancesUrl" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${glancesSettings.url || ''}" placeholder="http://192.168.1.100:61208"><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">If set, a link will appear in the header to open Glances in a modal.</p></div>
                                </div>
                            </div>
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gemini API Key</label><input type="password" id="geminiApiKey" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${allSettings.geminiApiKey || ''}" placeholder="Enter your Gemini API Key"><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Your key is stored in your browser's local storage and also saved to settings.json on your server.</p></div>
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">GitHub Token</label><input type="password" id="githubToken" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${allSettings.githubToken || ''}" placeholder="Enter your GitHub Personal Access Token"><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Used to fetch project descriptions and backup repositories.</p></div>
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Custom Chatbot Context</label><textarea id="chatbotContext" class="w-full h-32 px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Provide any additional context for the chatbot here...">${allSettings.chatbotContext || ''}</textarea><p class="text-xs text-slate-500 dark:text-slate-400 mt-1">The chatbot automatically reads context from <strong>server-info.html</strong> in your root directory, if it exists.</p></div>
                        </div>
                        <div id="backupSettings" class="settings-tab-content flex-grow overflow-y-auto p-6 space-y-6 hidden">
                             <div class="p-4 bg-slate-100 dark:bg-gray-700 rounded-lg"><h3 class="font-semibold mb-2 text-slate-800 dark:text-slate-200">Local Project Backup</h3><p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Create a .zip archive of all your project folders on this server.</p><button id="backup-all-btn" onclick="backupAllProjects()" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md">Create & Download Local Backup</button></div>
                             <div class="p-4 bg-slate-100 dark:bg-gray-700 rounded-lg"><h3 class="font-semibold mb-2 text-slate-800 dark:text-slate-200">GitHub Repositories Backup</h3><p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Download a .zip archive of all your personal repositories from GitHub.</p><button id="backup-github-btn" onclick="backupGitHubRepos()" class="w-full px-4 py-2 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900 transition-colors shadow-md">Create & Download GitHub Backup</button><p class="text-xs text-center text-slate-500 dark:text-slate-400 mt-3">Powered by <a href="https://gitvault.app/" target="_blank" class="text-blue-500 hover:underline">GitVault</a></p></div>
                        </div>
                        <div class="flex justify-between items-center p-5 border-t border-slate-200 dark:border-gray-700">
                             <div class="flex gap-4"><button class="px-4 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700 transition-colors" onclick="restoreDefaultSettings()">Restore Defaults</button></div>
                             <button id="save-settings-btn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md" onclick="saveAllSettings()">Save and Apply</button>
                        </div>
                    </div>
                </div>`;
            
            modalContainer.querySelector('.fixed').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
            
            loadWebsiteSettingsPanel();
        }
        
        function switchSettingsTab(tabName, button) {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tabName}Settings`).classList.remove('hidden');
            document.querySelectorAll('.flex.border-b button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-500');
                btn.classList.add('border-transparent', 'text-slate-500', 'hover:text-blue-500');
            });
            button.classList.add('border-blue-500', 'text-blue-500');
            button.classList.remove('border-transparent', 'text-slate-500', 'hover:text-blue-500');
        }

        async function loadWebsiteSettingsPanel() {
            const container = document.getElementById('website-list-container');
            if (!container) return;
            container.innerHTML = '<div class="text-slate-500 dark:text-slate-400">Loading websites...</div>';
            try {
                const items = await fetchFromBackend('action=list&path=/');
                if (items && !items.error) {
                    const siteFolders = items.filter(item => item.type === 'folder' && !['.', '..', 'phpmyadmin', 'images'].includes(item.name));
                    const sortedFolders = getSortedWebsites(siteFolders);
                    container.innerHTML = sortedFolders.map(item => {
                        const siteSettings = allSettings.websites[item.name] || {};
                        return `
                        <div class="settings-item bg-slate-50 dark:bg-gray-700/50 rounded-lg p-4 mt-4" data-name="${item.name}">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="handle cursor-grab text-slate-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></span>
                                <div class="flex flex-col"><button onclick="moveToTop(this)" title="Move to Top" class="p-1 text-slate-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg></button><button onclick="moveToBottom(this)" title="Move to Bottom" class="p-1 text-slate-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/></svg></button></div>
                                <h4 class="font-medium text-slate-900 dark:text-white flex-grow">${item.name}</h4>
                            </div>
                            <div class="space-y-4 pl-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Display Name</label><input type="text" data-key="displayName" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.displayName || item.name}"></div><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Logo Path</label><input type="text" data-key="logoPath" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.logoPath || ''}" placeholder="/${item.name}/logo.png"></div></div>
                                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Description</label><textarea data-key="description" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Fallback description...">${siteSettings.description || ''}</textarea></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">External Link URL</label><input type="url" data-key="externalLink" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.externalLink || ''}" placeholder="https://example.com"></div><div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">External Link Title</label><input type="text" data-key="externalLinkTitle" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.externalLinkTitle || ''}" placeholder="Visit Live Site"></div></div>
                                <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">GitHub Repo URL</label><input type="url" data-key="githubLink" class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${siteSettings.githubLink || ''}" placeholder="https://github.com/user/repo"></div>
                                <div class="pt-2 flex items-center justify-between"><label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300"><input type="checkbox" data-key="showInternalLink" class="rounded" ${siteSettings.showInternalLink !== false ? 'checked' : ''}> Show internal link</label><label class="flex items-center gap-2 text-sm text-slate-700 dark:text-slate-300"><input type="checkbox" data-key="isHidden" class="rounded" ${siteSettings.isHidden ? 'checked' : ''}> Hide this folder</label></div>
                            </div>
                        </div>`;
                    }).join('');
                    new Sortable(container, { handle: '.handle', animation: 150 });
                } else {
                    container.innerHTML = `<div class="text-red-500">Error: ${items.error || 'Unknown'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
            }
        }
        
        async function saveAllSettings() {
            const btn = document.getElementById('save-settings-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Saving...</span>';

            const newSettings = { ...allSettings };
            newSettings.geminiApiKey = document.getElementById('geminiApiKey')?.value || '';
            newSettings.githubToken = document.getElementById('githubToken')?.value || '';
            newSettings.chatbotContext = document.getElementById('chatbotContext')?.value || '';
            newSettings.glances = {
                enabled: document.getElementById('glancesEnabled')?.checked || false,
                url: document.getElementById('glancesUrl')?.value.trim() || ''
            };
            localStorage.setItem('geminiApiKey', newSettings.geminiApiKey);
            newSettings.websites = newSettings.websites || {};
            newSettings.websitesOrder = [];

            document.querySelectorAll('#website-list-container > .settings-item').forEach(div => {
                const name = div.dataset.name;
                newSettings.websitesOrder.push(name);
                const existingSiteSettings = allSettings.websites[name] || {};
                newSettings.websites[name] = { ...existingSiteSettings };
                div.querySelectorAll('input, textarea').forEach(input => {
                    const key = input.dataset.key;
                    if (key) {
                        newSettings.websites[name][key] = input.type === 'checkbox' ? input.checked : input.value;
                    }
                });
            });

            try {
                const response = await fetch('browser.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save_settings', settings: newSettings })
                });
                const result = await response.json();
                if (result.success) {
                    allSettings = newSettings; // Update global settings object
                    closeModal();
                    await renderPage(); // Re-render the page with new settings
                    // Re-initialize glances if settings changed
                    if (glancesInterval) clearInterval(glancesInterval);
                    if (allSettings.glances.enabled) {
                        refreshGlancesStats();
                        glancesInterval = setInterval(refreshGlancesStats, 2000);
                    } else {
                        document.getElementById('glances-stats').classList.add('hidden');
                    }
                } else {
                    alert(`Failed to save settings: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error saving settings: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Save and Apply';
            }
        }

        // --- View & Theme Management ---

        function toggleView() {
            currentView = currentView === 'grid' ? 'list' : 'grid';
            localStorage.setItem('dashboardView', currentView);
            updateView();
        }

        function updateView() {
            const gridView = document.getElementById('websites-grid');
            const listView = document.getElementById('websites-list');
            const viewToggleButton = document.getElementById('view-toggle-button');

            if (currentView === 'grid') {
                gridView.classList.remove('hidden');
                listView.classList.add('hidden');
                viewToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>`;
                viewToggleButton.title = "Switch to List View";
            } else {
                gridView.classList.add('hidden');
                listView.classList.remove('hidden');
                viewToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`;
                viewToggleButton.title = "Switch to Grid View";
            }
            if (siteDataCache.length > 0) renderContent(siteDataCache);
        }

        function applyTheme(theme) {
            const themeToggle = document.getElementById('theme-toggle');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

        // --- Core Application Logic ---

        function getSortedWebsites(siteFolders) {
            const order = allSettings.websitesOrder || [];
            const sortedSiteFolders = [...siteFolders].sort((a, b) => a.name.localeCompare(b.name));
            return sortedSiteFolders.sort((a, b) => {
                const indexA = order.indexOf(a.name);
                const indexB = order.indexOf(b.name);
                if (indexA > -1 && indexB > -1) return indexA - indexB;
                if (indexA > -1) return -1;
                if (indexB > -1) return 1;
                return 0; 
            });
        }

        // --- Content Rendering ---

        function renderContent(siteFolders) {
            if (currentView === 'grid') {
                renderGridView(siteFolders);
            } else {
                renderListView(siteFolders);
            }
        }
        
        function renderGridView(siteFolders) {
            const websitesGrid = document.getElementById('websites-grid');
            const sortedFolders = getSortedWebsites(siteFolders);
            websitesGrid.innerHTML = '';
            if (sortedFolders.length === 0) {
                websitesGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center py-10">No website folders found or all are hidden.</p>';
            } else {
                sortedFolders.forEach((folder, index) => {
                    websitesGrid.appendChild(createWebsiteCard(folder, index));
                });
            }
        }

        function renderListView(siteFolders) {
            const websitesList = document.getElementById('websites-list');
            const sortedFolders = [...siteFolders].sort((a, b) => {
                const valA = a.name.toLowerCase();
                const valB = b.name.toLowerCase();
                if (valA < valB) return listSortConfig.order === 'asc' ? -1 : 1;
                if (valA > valB) return listSortConfig.order === 'asc' ? 1 : -1;
                return 0;
            });
            const getSortIndicator = (column) => listSortConfig.by === column ? `<span class="ml-1">${listSortConfig.order === 'asc' ? 'â–²' : 'â–¼'}</span>` : '';
            let listHtml = `
                <div class="bg-white dark:bg-gray-800 border border-slate-200 dark:border-gray-700 rounded-xl overflow-hidden">
                    <div class="grid grid-cols-3 gap-4 p-4 font-semibold text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-gray-700/50 border-b border-slate-200 dark:border-gray-700 text-sm">
                        <div class="col-span-2 cursor-pointer hover:text-blue-500 flex items-center" onclick="setListSort('name')">Project ${getSortIndicator('name')}</div>
                        <div class="text-right">Actions</div>
                    </div><div>`;
            if (sortedFolders.length === 0) {
                listHtml += '<p class="text-slate-500 text-center p-10">No projects to display.</p>';
            } else {
                sortedFolders.forEach(folder => { listHtml += createWebsiteListItem(folder); });
            }
            listHtml += `</div></div>`;
            websitesList.innerHTML = listHtml;
        }
        
        function setListSort(sortBy) {
            if (listSortConfig.by === sortBy) {
                listSortConfig.order = listSortConfig.order === 'asc' ? 'desc' : 'asc';
            } else {
                listSortConfig.by = sortBy;
                listSortConfig.order = 'asc';
            }
            renderListView(siteDataCache);
        }
        
        function createWebsiteListItem(siteData) {
            const siteSettings = allSettings.websites[siteData.name] || {};
            const displayName = siteSettings.displayName || siteData.name;
            const logoSrc = siteSettings.logoPath || `/${siteData.name}/logo.png`;
            const placeholderHtml = `<div class='w-6 h-6 rounded-md flex items-center justify-center overflow-hidden bg-slate-200 dark:bg-gray-600 text-xs font-bold text-slate-500 dark:text-slate-300'>${displayName.charAt(0).toUpperCase()}</div>`;
            const logoHtml = `<div class="w-6 h-6 mr-3 flex-shrink-0"><img src="${logoSrc}" alt="${displayName} Logo" class="w-full h-full object-contain rounded-md" onerror="this.parentElement.innerHTML = '${placeholderHtml}'"></div>`;
            const showInternal = siteSettings.showInternalLink !== false;
            const externalLink = siteSettings.externalLink;
            const externalTitle = siteSettings.externalLinkTitle || 'Visit Link';
            const githubLink = siteSettings.githubLink;
            let buttonsHtml = '';
            if (showInternal) buttonsHtml += `<a href="/${siteData.name}/" target="_blank" class="px-3 py-1 text-sm bg-slate-200 dark:bg-gray-600 text-slate-800 dark:text-slate-200 font-medium rounded-md hover:bg-slate-300 dark:hover:bg-gray-500 transition-colors">Local</a>`;
            if (externalLink) buttonsHtml += `<a href="${externalLink}" target="_blank" class="px-3 py-1 text-sm bg-blue-100 text-blue-800 font-medium rounded-md hover:bg-blue-200 transition-colors">...</a>`;
            if (githubLink) buttonsHtml += `<a href="${githubLink}" target="_blank" class="px-3 py-1 text-sm bg-gray-800 text-white font-medium rounded-md hover:bg-gray-900 transition-colors">GitHub</a>`;
            buttonsHtml += `<button onclick="openCodebaseChat('${siteData.name}')" class="px-3 py-1 text-sm bg-indigo-100 text-indigo-800 font-medium rounded-md hover:bg-indigo-200 transition-colors">Ask AI</button>`;
            return `<div class="grid grid-cols-3 gap-4 p-4 items-center border-b border-slate-200 dark:border-gray-700 last:border-b-0 hover:bg-slate-50 dark:hover:bg-gray-700/50 transition-colors duration-150"><div class="col-span-2 font-medium text-slate-900 dark:text-white flex items-center">${logoHtml}<span>${displayName}</span></div><div class="flex justify-end items-center gap-2">${buttonsHtml}</div></div>`;
        }

        function createWebsiteCard(siteData, index) {
            const card = document.createElement('div');
            card.className = 'card-animated bg-white dark:bg-gray-800 p-6 rounded-xl hover:scale-105 border border-slate-200 dark:border-gray-700 hover:border-blue-500 transition-all duration-300 flex flex-col';
            card.style.animationDelay = `${index * 50}ms`;
            card.id = `card-${siteData.name}`;
            card.dataset.projectName = siteData.name;

            const siteSettings = allSettings.websites[siteData.name] || {};
            const displayName = siteSettings.displayName || siteData.name;
            const description = siteSettings.githubDescription || siteSettings.description || 'A local development project.';
            const tags = siteSettings.tags || [];
            const logoSrc = siteSettings.logoPath || `/${siteData.name}/logo.png`;
            const placeholderHtml = `<div class='w-24 h-24 rounded-full flex items-center justify-center overflow-hidden bg-slate-100 dark:bg-gray-700'><span class='text-4xl font-bold text-slate-500 dark:text-slate-300'>${displayName.charAt(0).toUpperCase()}</span></div>`;
            const logoContainerHtml = `<div class="w-24 h-24 mb-4 flex items-center justify-center"><img src="${logoSrc}" alt="${displayName} Logo" class="max-w-full max-h-full object-contain" onerror="this.parentElement.innerHTML = '${placeholderHtml}'"></div>`;
            const tagsHtml = tags.length > 0 ? `<div class="flex flex-wrap justify-center gap-2 mt-4">${tags.map(tag => `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${tag}</span>`).join('')}</div>` : '';
            const showInternal = siteSettings.showInternalLink !== false;
            const externalLink = siteSettings.externalLink;
            const externalTitle = siteSettings.externalLinkTitle || 'Visit Link';
            const githubLink = siteSettings.githubLink;
            let mainButtonHtml = '';
            if (externalLink) mainButtonHtml = `<a href="${externalLink}" target="_blank" class="flex-1 block text-center px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all duration-200">${externalTitle}</a>`;
            else if (showInternal) mainButtonHtml = `<a href="/${siteData.name}/" target="_blank" class="flex-1 block text-center px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all duration-200">Visit Local</a>`;
            let iconButtonsHtml = '';
            if (externalLink && showInternal) iconButtonsHtml += `<a href="/${siteData.name}/" target="_blank" title="Visit Local" class="p-3 bg-slate-200 dark:bg-gray-600 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-gray-500 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>`;
            if (githubLink) iconButtonsHtml += `<a href="${githubLink}" target="_blank" title="View on GitHub" class="p-3 bg-slate-200 dark:bg-gray-600 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-gray-500 rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a>`;
            const buttonsHtml = mainButtonHtml ? `<div class="flex items-center gap-2">${mainButtonHtml}${iconButtonsHtml}</div>` : '';
            const footerHtml = buttonsHtml ? `<div class="mt-4 pt-4 border-t border-slate-200 dark:border-gray-700"><div class="flex items-center gap-3">${buttonsHtml}</div></div>` : '';
            const aiFeaturesHtml = `<div class="mt-4 pt-4 border-t border-slate-200 dark:border-gray-700 flex flex-col sm:flex-row gap-2"><button onclick="openCodebaseChat('${siteData.name}')" class="w-full text-sm px-3 py-2 bg-slate-200 dark:bg-gray-600 hover:bg-slate-300 dark:hover:bg-gray-500 rounded-lg transition-colors flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg> Ask Codebase</button></div>`;
            card.innerHTML = `
                <div class="flex-grow flex flex-col items-center text-center">
                    ${logoContainerHtml}
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">${displayName}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mt-2 h-10">${description}</p>
                    ${tagsHtml}
                </div>
                ${aiFeaturesHtml}${footerHtml}`;

            return card;
        }

        async function fetchGitHubDataForProjects() {
            const token = allSettings.githubToken;
            if (!token) {
                console.warn("GitHub token not set. Skipping GitHub data fetch.");
                return;
            };
            const promises = [], siteNamesWithLinks = [];
            if (!allSettings.websites) allSettings.websites = {};
            for (const siteName in allSettings.websites) {
                const site = allSettings.websites[siteName];
                if (site && site.githubLink) {
                    const match = site.githubLink.match(/github\.com\/([^\/]+\/[^\/]+)/);
                    if (match && match[1]) {
                        const repoPath = match[1].replace('.git', '');
                        const url = `https://api.github.com/repos/${repoPath}`;
                        promises.push(
                            fetch(`${PROXY_URL}${url}`, { headers: { 'Authorization': `token ${token}` } })
                            .then(res => {
                                if (!res.ok) {
                                    return Promise.reject(new Error(`GitHub API Error for ${repoPath}: ${res.status} ${res.statusText}`));
                                }
                                return res.json();
                            })
                        );
                        siteNamesWithLinks.push(siteName);
                    }
                }
            }
            if (promises.length === 0) return;
            const results = await Promise.allSettled(promises);
            results.forEach((result, index) => {
                const siteName = siteNamesWithLinks[index];
                if (!allSettings.websites[siteName]) allSettings.websites[siteName] = {};
                if (result.status === 'fulfilled') {
                    const repoData = result.value;
                    allSettings.websites[siteName].githubDescription = repoData.description || '';
                    allSettings.websites[siteName].tags = repoData.topics || [];
                } else {
                    console.warn(`Failed to fetch GitHub data for ${siteName}:`, result.reason.message);
                }
            });
        }

        async function renderPage() {
            const websitesGrid = document.getElementById('websites-grid');
            websitesGrid.innerHTML = '<p class="text-slate-500 dark:text-slate-400 col-span-full">Loading projects...</p>';
            await fetchGitHubDataForProjects();
            try {
                const items = await fetchFromBackend('action=list&path=/');
                if (items && !items.error) {
                    siteDataCache = items.filter(item => {
                        const settings = allSettings.websites && allSettings.websites[item.name];
                        const isHidden = settings && settings.isHidden;
                        const isExcluded = ['.', '..', 'phpmyadmin', 'images'].includes(item.name);
                        return item.type === 'folder' && !isHidden && !isExcluded;
                    });
                    renderContent(siteDataCache);
                } else {
                    websitesGrid.innerHTML = `<p class="text-red-500 col-span-full">Could not load websites.</p>`;
                }
            } catch (e) {
                websitesGrid.innerHTML = `<p class='text-red-500 font-bold col-span-full'>Error: ${e.message}</p>`;
            }
        }
        
        // --- Gemini Chatbot & AI Features ---

        async function openCodebaseChat(projectName) {
            openChatbot(projectName);
        }

        async function openChatbot(projectName = null) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            const title = projectName ? `Code Assistant: '${projectName}'` : 'Server Assistant';
            let modalHtml = `
                <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center sm:items-center z-50 animate-fadeIn" onclick="if (event.target === this) closeModal()">
                    <div class="modal-content bg-white dark:bg-gray-800 rounded-t-lg sm:rounded-lg shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col animate-scaleIn">
                        <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-gray-700">
                            <h2 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg>${title}</h2>
                            <button class="text-slate-500 dark:text-slate-400 hover:text-blue-500 transition-colors" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                        <div class="flex-grow flex overflow-hidden">
                            ${projectName ? `<div class="w-1/3 border-r border-slate-200 dark:border-gray-700 overflow-y-auto p-2"><div id="file-browser" class="text-sm">Loading files...</div></div><div id="code-chat-view" class="w-2/3 flex flex-col"><div id="file-content-view" class="flex-grow bg-slate-50 dark:bg-gray-900 overflow-y-auto relative"><p class="text-slate-500 dark:text-slate-400 p-4">Select a file to view its content.</p></div><div id="refactor-button-container" class="p-2 border-t border-slate-200 dark:border-gray-700 hidden"><button id="refactor-btn" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors shadow-md">Analyze & Refactor File</button></div>` : `<div id="code-chat-view" class="w-full flex flex-col">`}
                                <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
                                <div class="p-4 border-t border-slate-200 dark:border-gray-700">
                                    <form id="chat-form" class="flex items-center gap-3">
                                        <input type="text" id="chat-input" class="flex-grow px-3 py-2 bg-white dark:bg-gray-900 border border-slate-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ask about your server...">
                                        <button type="submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11zM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493z"/></svg></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            modalContainer.innerHTML = modalHtml;
            chatHistory = [];
            renderChatHistory();
            if (projectName) loadProjectFiles(projectName);
            document.getElementById('chat-form').addEventListener('submit', (e) => { e.preventDefault(); sendMessageToGemini(projectName); });
        }

        function renderChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = '';
            chatHistory.forEach(msg => {
                const messageEl = document.createElement('div');
                if (msg.role === 'user') {
                    messageEl.className = 'flex justify-end';
                    messageEl.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs sm:max-w-md">${msg.parts[0].text}</div>`;
                } else {
                    messageEl.className = 'flex justify-start';
                    messageEl.innerHTML = `<div class="bg-slate-200 dark:bg-gray-700 p-3 rounded-lg max-w-xs sm:max-w-md">${msg.parts[0].text}</div>`;
                }
                messagesContainer.appendChild(messageEl);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessageToGemini(projectName = null) {
            const input = document.getElementById('chat-input');
            const userInput = input.value.trim();
            if (!userInput) return;
            const apiKey = allSettings.geminiApiKey;
            if (!apiKey) { alert('Please set your Gemini API Key in the settings first.'); return; }
            chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            renderChatHistory();
            input.value = '';
            const messagesContainer = document.getElementById('chat-messages');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'flex justify-start';
            loadingEl.innerHTML = `<div class="bg-slate-200 dark:bg-gray-700 p-3 rounded-lg"><span class="animate-pulse">...</span></div>`;
            messagesContainer.appendChild(loadingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            let systemPrompt = '';
            if (projectName) {
                const { fileList, fileContents } = await getProjectContext(projectName);
                systemPrompt = `You are a helpful code assistant for a project named '${projectName}'. Here is the file structure:\n${fileList}\n\nHere are the contents of key files:\n${fileContents}\n\nAnswer the user's questions based on this context.`;
            } else {
                const items = await fetchFromBackend('action=list&path=/');
                const fileList = items && !items.error ? "Project folders:\n - " + items.map(i => i.name).join('\n - ') : 'No project folders available.';
                systemPrompt = `You are a helpful server assistant.\n\n${fileList}\n\nAdditional context:\n${allSettings.chatbotContext || "None"}`;
            }
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: chatHistory, systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                chatHistory.push({ role: "model", parts: [{ text: result.candidates[0].content.parts[0].text }] });
            } catch (error) {
                chatHistory.push({ role: "model", parts: [{ text: `Sorry, error: ${error.message}` }] });
            } finally {
                loadingEl.remove();
                renderChatHistory();
            }
        }

        function createFileTree(node, container) {
            const item = document.createElement('div');
            const folderIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16"><path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996.81l.637 7a1 1 0 0 0 .995.89h10.348a1 1 0 0 0 .995-.89l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/></svg>`;
            const fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-text" viewBox="0 0 16 16"><path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/><path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/></svg>`;

            if (node.type === 'folder') {
                item.innerHTML = `<details><summary class="p-1 cursor-pointer hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md file-tree-item">${folderIcon} ${node.name}</summary><div class="pl-4"></div></details>`;
                const childrenContainer = item.querySelector('div');
                node.children.sort((a, b) => a.type.localeCompare(b.type) || a.name.localeCompare(b.name)).forEach(child => createFileTree(child, childrenContainer));
            } else {
                item.innerHTML = `<div class="p-1 cursor-pointer hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md file-tree-item" onclick="loadFileContent('${node.path}')">${fileIcon} ${node.name}</div>`;
            }
            container.appendChild(item);
        }

        async function loadProjectFiles(projectName) {
            const fileBrowser = document.getElementById('file-browser');
            try {
                const tree = await fetchFromBackend(`action=list_recursive_tree&path=/${projectName}/`);
                if (tree.error) throw new Error(tree.error);
                fileBrowser.innerHTML = '';
                // Sort top-level files and folders
                tree.sort((a, b) => a.type.localeCompare(b.type) || a.name.localeCompare(b.name)).forEach(node => createFileTree(node, fileBrowser));
            } catch (error) {
                fileBrowser.innerHTML = `<p class="text-red-500 p-2">Error: ${error.message}</p>`;
            }
        }
        
        async function loadFileContent(filePath) {
            const fileContentDiv = document.getElementById('file-content-view');
            const refactorContainer = document.getElementById('refactor-button-container');
            fileContentDiv.innerHTML = `<p class="text-slate-500 dark:text-slate-400 animate-pulse p-4">Loading ${filePath}...</p>`;
            refactorContainer.classList.add('hidden');
            try {
                const result = await fetchFromBackend(`action=get_content&path=${encodeURIComponent(filePath)}`);
                if (result.error) throw new Error(result.error);

                if (result.content === null || result.content.trim() === '' || result.content.includes('[Binary file content not displayed]')) {
                    fileContentDiv.innerHTML = `<p class="text-slate-500 dark:text-slate-400 p-4">${result.content !== null && result.content.trim() === '' ? '[File is empty]' : result.content || '[Could not read file]'}</p>`;
                    refactorContainer.classList.add('hidden');
                    return;
                }

                fileContentDiv.innerHTML = ''; 
                const editorContainer = document.createElement('textarea');
                editorContainer.value = result.content;
                fileContentDiv.appendChild(editorContainer);
                
                const mode = filePath.split('.').pop();
                let mime = 'text/plain';
                if (['js', 'json'].includes(mode)) mime = 'application/javascript';
                if (['html', 'xml'].includes(mode)) mime = 'application/xml';
                if (mode === 'css') mime = 'text/css';
                if (mode === 'php') mime = 'application/x-httpd-php';

                codeEditor = CodeMirror.fromTextArea(editorContainer, {
                    mode: mime,
                    theme: 'material-darker',
                    lineNumbers: true,
                    readOnly: true
                });
                
                setTimeout(() => codeEditor.refresh(), 1);
                
                refactorContainer.classList.remove('hidden');
                document.getElementById('refactor-btn').onclick = () => initiateRefactoring(filePath, result.content);
            } catch (error) {
                fileContentDiv.innerHTML = `<p class="text-red-500 p-4">Error: ${error.message}</p>`;
            }
        }
        
        async function initiateRefactoring(filePath, originalContent) {
            const apiKey = allSettings.geminiApiKey;
            if (!apiKey) { alert('Please set your Gemini API Key in the settings first.'); return; }
            const btn = document.getElementById('refactor-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Analyzing...</span>';
            const prompt = `You are an expert programmer performing a code review on the file "${filePath}". Analyze the code for clarity, efficiency, and best practices, then provide a refactored version. You MUST return a clean JSON object and NOTHING ELSE. The JSON response must strictly adhere to the schema: { "refactored_code": "string", "explanation": "string (concise, bulleted Markdown)", "is_refactored": boolean }. Original Code:\n\`\`\`\n${originalContent.substring(0, 8000)}\n\`\`\``;
            try {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const rawText = result.candidates[0].content.parts[0].text;
                const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("No valid JSON object found in AI response.");
                const refactorData = JSON.parse(jsonMatch[0]);
                displayRefactorModal(filePath, originalContent, refactorData.refactored_code, refactorData.explanation, refactorData.is_refactored);
            } catch (error) {
                alert(`Refactoring error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Analyze & Refactor File';
            }
        }

        function displayRefactorModal(filePath, originalCode, refactoredCode, explanation, isRefactored) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn';
            
            const modalBody = `
                <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col animate-scaleIn">
                    <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-slate-200 dark:border-gray-700">
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Refactoring Suggestions</h2>
                        <button class="text-slate-500 hover:text-blue-500 close-refactor-modal"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <div class="flex-grow flex flex-col p-4 overflow-hidden gap-4">
                        <div class="h-2/3 grid grid-cols-1 md:grid-cols-2 gap-4" style="min-height: 0;">
                            <div class="flex flex-col"><h3 class="font-semibold mb-2">Original</h3><div class="flex-grow bg-slate-100 dark:bg-gray-900 rounded-lg overflow-auto p-2"><pre class="text-sm"><code>${escapeHtml(originalCode)}</code></pre></div></div>
                            <div class="flex flex-col"><h3 class="font-semibold mb-2">Refactored</h3><div class="flex-grow bg-slate-100 dark:bg-gray-900 rounded-lg overflow-auto p-2"><pre class="text-sm"><code>${escapeHtml(refactoredCode)}</code></pre></div></div>
                        </div>
                        <div class="h-1/3 flex flex-col border-t border-slate-200 dark:border-gray-700 pt-4"><h3 class="font-semibold mb-2">Explanation</h3><div class="flex-grow bg-slate-100 dark:bg-gray-900 rounded-lg overflow-auto p-2"><div class="text-sm prose max-w-none">${isRefactored ? explanation : '<p>No changes were needed.</p>'}</div></div></div>
                    </div>
                    <div class="flex-shrink-0 flex justify-end p-4 border-t border-slate-200 dark:border-gray-700">
                        <button id="apply-refactor-btn" class="px-5 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors shadow-md">Apply & Save</button>
                    </div>
                </div>`;

            modal.innerHTML = modalBody;
            modalContainer.appendChild(modal);

            modal.querySelector('.close-refactor-modal').addEventListener('click', () => modal.remove());
            modal.querySelector('#apply-refactor-btn').addEventListener('click', () => {
                applyRefactor(filePath, refactoredCode);
                modal.remove();
            });
        }

        async function applyRefactor(filePath, content) {
            const response = await fetch('browser.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'save_content', path: filePath, content: content })
            });
            const result = await response.json();
            if (result.success) {
                alert('File saved successfully!');
                codeEditor.setValue(content);
            } else {
                alert(`Failed to save file: ${result.error}`);
            }
        }
        
        function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        
        async function getProjectContext(projectName) {
            const files = await fetchFromBackend(`action=list_recursive_tree&path=/${projectName}/`);
            if (files.error) throw new Error(files.error);
            const fileList = JSON.stringify(files, null, 2);
            let fileContents = [];
            const importantFiles = ['index.html', 'index.php', 'package.json', 'composer.json', 'README.md'];
            
            async function findAndRead(tree) {
                for (const node of tree) {
                    if (node.type === 'file' && importantFiles.includes(node.name)) {
                        const content = await fetchFromBackend(`action=get_content&path=${encodeURIComponent(node.path)}`);
                        if (content && !content.error) fileContents.push(`--- ${node.path} ---\n${content.content.substring(0, 1000)}\n---`);
                    } else if (node.type === 'folder') {
                        await findAndRead(node.children);
                    }
                }
            }
            await findAndRead(files);
            return { fileList, fileContents: fileContents.join('\n\n') };
        }

        async function refreshAllGitHubData() {
            const btn = document.getElementById('refresh-github-btn');
            if (!btn) return;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Refreshing...</span>';
            try {
                await fetchGitHubDataForProjects();
                // After fetching, we need to re-save the settings with the new data
                const response = await fetch('browser.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save_settings', settings: allSettings })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Failed to save updated GitHub data.');
                
                await renderPage(); // Re-render the main page to show new details
                loadWebsiteSettingsPanel(); // Also refresh the list inside the settings modal

            } catch (error) {
                alert('Failed to refresh GitHub data. Check console for details.');
                console.error('Failed to refresh GitHub data:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Refresh GitHub Data';
            }
        }
        
        function backupAllProjects() {
            const btn = document.getElementById('backup-all-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">Creating backup...</span>';
            window.location.href = 'browser.php?action=backup_all';
            setTimeout(() => { btn.disabled = false; btn.innerHTML = 'Create & Download Local Backup'; }, 3000);
        }

        // --- GitHub Backup Functions ---
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
        async function fetchWithRetry(fn, retries, delayMs, repoName) {
            for (let i = 0; i < retries; i++) { try { return await fn(); } catch (error) { await delay(delayMs); } }
            throw new Error(`Failed after ${retries} retries`);
        }
        async function fetchAllGitHubRepos(token) {
            let allRepos = [], page = 1, hasNextPage = true;
            while (hasNextPage) {
                const res = await fetch(`${PROXY_URL}https://api.github.com/user/repos?type=all&per_page=100&page=${page}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
                const repos = await res.json();
                if (repos.length === 0) hasNextPage = false;
                else { allRepos = allRepos.concat(repos.map(r => ({ name: r.full_name.replace('/', '_'), url: r.url }))); page++; }
            }
            return allRepos;
        }
        async function fetchBinary(url, token) {
            const res = await fetch(`${PROXY_URL}${url}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error(`(${res.status}) Failed to download`);
            return await res.blob();
        }
        async function backupGitHubRepos() {
            const btn = document.getElementById('backup-github-btn');
            const token = allSettings.githubToken;
            if (!token) { alert('Please set your GitHub Token first.'); return; }
            btn.disabled = true;
            try {
                btn.innerHTML = '<span class="animate-pulse">Fetching repos...</span>';
                const repos = await fetchAllGitHubRepos(token);
                if (repos.length === 0) { alert('No repositories found.'); return; }
                const zip = new JSZip();
                for (let i = 0; i < repos.length; i++) {
                    btn.innerHTML = `<span class="animate-pulse">Downloading ${i + 1}/${repos.length}...</span>`;
                    try {
                        const zipballUrl = `${repos[i].url}/zipball`;
                        const blob = await fetchWithRetry(() => fetchBinary(zipballUrl, token), 3, 1000, repos[i].name);
                        zip.file(`${repos[i].name}.zip`, blob);
                    } catch (error) {
                        zip.file(`${repos[i].name}-FAILED.txt`, `Could not download.`);
                    }
                }
                btn.innerHTML = '<span class="animate-pulse">Compressing...</span>';
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `github-backup-${new Date().toISOString().slice(0, 10)}.zip`);
            } catch (error) {
                alert(`GitHub backup failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Create & Download GitHub Backup';
            }
        }
        
        function openGlancesModal() {
            const glancesUrl = allSettings.glances?.url;
            if (!glancesUrl) return;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('hidden');
            modalContainer.innerHTML = `<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"><div class="modal-content bg-slate-100 dark:bg-gray-800 rounded-lg shadow-2xl w-full h-full max-w-7xl max-h-[90vh] flex flex-col animate-scaleIn"><div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-t-lg"><h2 class="text-lg font-semibold text-slate-900 dark:text-white">Glances System Monitor</h2><div class="flex items-center gap-2"><a href="${glancesUrl}" target="_blank" class="text-slate-500 hover:text-blue-500" title="Open in new tab"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg></a><button class="text-slate-500 hover:text-blue-500" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div><div class="flex-grow p-2 bg-slate-100 dark:bg-gray-800 rounded-b-lg"><iframe src="${glancesUrl}" class="w-full h-full border-0 rounded-md"></iframe></div></div></div>`;
        }

        async function refreshGlancesStats() {
            if (!allSettings.glances || !allSettings.glances.enabled) {
                document.getElementById('glances-stats').classList.add('hidden');
                if (glancesInterval) { clearInterval(glancesInterval); glancesInterval = null; }
                return;
            }
            document.getElementById('glances-stats').classList.remove('hidden');
            try {
                const [quicklook, fs] = await Promise.all([
                    fetch('/glances.php?p=quicklook').then(r => r.json()),
                    fetch('/glances.php?p=fs').then(r => r.json())
                ]);
                if (quicklook && quicklook.cpu) { document.getElementById('cpu-usage').textContent = quicklook.cpu.toFixed(1); document.getElementById('cpu-bar').style.width = `${quicklook.cpu}%`; }
                if (quicklook && quicklook.mem) { document.getElementById('mem-usage').textContent = quicklook.mem.toFixed(1); document.getElementById('mem-bar').style.width = `${quicklook.mem}%`; }
                const rootFs = fs && fs.find(f => f.mnt_point === '/');
                if (rootFs) { document.getElementById('disk-usage').textContent = rootFs.percent.toFixed(1); document.getElementById('disk-bar').style.width = `${rootFs.percent}%`; }
            } catch (error) {
                console.error('Could not fetch Glances stats:', error.message);
                ['cpu-usage', 'mem-usage', 'disk-usage'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = 'N/A'; });
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const styleSheet = document.createElement("style");
            styleSheet.innerText = `@keyframes fadeIn{from{opacity:0}to{opacity:1}}.animate-fadeIn{animation:fadeIn .3s ease-out forwards}@keyframes fadeOut{from{opacity:1}to{opacity:0}}.animate-fadeOut{animation:fadeOut .3s ease-in forwards}@keyframes scaleIn{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}.animate-scaleIn{animation:scaleIn .3s ease-out forwards}`;
            document.head.appendChild(styleSheet);

            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            currentView = localStorage.getItem('dashboardView') || 'grid';
            document.getElementById('view-toggle-button').addEventListener('click', toggleView);
            updateView();

            document.getElementById('search-input').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#websites-grid .card-animated').forEach(card => {
                    const siteSettings = allSettings.websites[card.dataset.projectName] || {};
                    const name = (siteSettings.displayName || card.dataset.projectName).toLowerCase();
                    const tags = (siteSettings.tags || []).join(' ').toLowerCase();
                    if (name.includes(searchTerm) || tags.includes(searchTerm)) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });

            try {
                const response = await fetch('settings.json?t=' + new Date().getTime());
                allSettings = response.ok ? await response.json() : { websites: {}, websitesOrder: [] };
            } catch (e) {
                allSettings = { websites: {}, websitesOrder: [] };
            }
            allSettings.geminiApiKey = localStorage.getItem('geminiApiKey') || allSettings.geminiApiKey;
            
            await renderPage();
            
            if (allSettings.glances?.url) document.getElementById('glances-link-container').classList.remove('hidden');
            if (allSettings.glances?.enabled) {
                refreshGlancesStats();
                glancesInterval = setInterval(refreshGlancesStats, 2000);
            }
        });
    </script>
</body>
</html>
